name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          cache: true

      - name: Lint
        run: pixi run lint

      - name: Test
        run: pixi run test

      - name: Spec Conformance
        run: pixi run conformance

      - name: Full Spec Audit
        run: pixi run spec-audit-strict

      - name: CBQN Catalog Report
        run: pixi run cbqn-catalog

      - name: CI Pass Dashboard
        run: pixi run ci-dashboard

      - name: Benchmark Stability Gate
        run: pixi run bench-gate

      - name: Benchmark Monad/Dyad Top-5 Gate
        run: pixi run bench-md-gate

      - name: Perf Snapshot (Non-Blocking)
        if: always()
        continue-on-error: true
        run: pixi run perf-snapshot

      - name: Upload Conformance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-and-bench-gate
          path: benchmarks/output/conformance
          if-no-files-found: ignore

      - name: Upload Performance Snapshot Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-snapshots
          path: benchmarks/output/perf_ci
          if-no-files-found: ignore
