"""Batch-test all stateful notebook expressions to find failures."""
import sys, os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))
from bqn_jax.evaluator import evaluate, EvaluationEnvironment

# Each notebook is a list of (cell#, [expr, ...])
NOTEBOOKS = {
  "01_expressions": [
    (5, ['2 + 3', '6-   5', '- 1.5']),
    (6, ['2 × π', '9 ÷ 2', '÷ ∞']),
    (7, ['2 ⋆ 3', '3 ⋆ 2', '⋆ 1', '⋆ 2.3']),
    (8, ['√ 2', '3 √ 27']),
    (10, ['2×3 - 5', '(2×3) - 5']),
    (11, ['(4÷3) × π × 2⋆3']),
    (13, ['√ 3 + 2 × √2', '1 + √2']),
    (14, ['(√3 + 2×√2) - 1+√2']),
    (16, ["'c'"]),
    (17, ["'c' + 1", "'h' - 'a'"]),
    (18, ["'K' + 'a'-'A'"]),
    (19, ["'4' - '0'"]),
    (20, ["'*' - @", '@ + 97']),
    (22, ["2 -˜ 'd'", '+˜ 3']),
    (23, ['×˜ 5', '2 ⋆˜ 5']),
    (24, ['√⁼ 5']),
    (25, ['⋆⁼ 10', '2 ⋆⁼ 32', '2 ⋆ 2 ⋆⁼ 32', '10 ⋆⁼ 1e4']),
    (26, ['2 3˙ 4']),
    (28, ['3 ×˜∘+ 4', '-∘(×˜) 5']),
  ],
  "02_list_manipulation": [
    (5, ['⟨1, 2, 3⟩']),
    (6, ['⟨1, 2, 3⟩ + 1']),
    (8, ['0‿1‿2', '(0‿1)‿2', '0‿(1‿2)']),
    (11, ['÷ ⟨2,3,4⟩', '"APL" + 1', '"31415" - \'0\'', '4‿3‿2‿1 ⋆ 1‿2‿3‿4']),
    (12, ['2 × ⟨0‿2 ⋄ 1‿3‿5⟩', '⟨ 10, 20‿30 ⟩ + ⟨ 1‿2, 3 ⟩']),
    (14, ['⋈ "elt"', '2 ⋈ 4']),
    (15, ['⟨1,2,3⟩ ∾ "abc"', '0 ∾ ⟨1,2,3⟩', '"plural" ∾ \'s\'']),
    (16, ['⌽ "drawer"']),
    (17, ['2 ⌽ ⟨0,1,2,3,4⟩', '¯1 ⌽ "bcdea"']),
    (18, ['⌽¨ "abcd"‿"ABCDEF"‿"01"']),
    (19, ['"abc" ⋈¨ "ABC"', '"string"‿"list"‿"array" ∾¨ \'s\'']),
    (20, ['+´ 2‿3‿4', '×´ 2‿3‿4']),
    (21, ['-´ 1‿2‿3‿4‿5', '1-2-3-4-5']),
    (22, ['∾´ ⟨ "con", "cat", "enat", "e" ⟩']),
    (23, ['∾ ⟨ "con", "cat", "enat", "e" ⟩']),
    (25, ['↕ 8']),
    (26, ['8‿4‿2‿1 ⋈¨ 1‿0‿0‿1']),
    (27, ['+´ 8‿4‿2‿1 × 1‿0‿0‿1']),
    (28, ['2 ⋆ ↕4', '⌽2⋆↕4', '(⌽2⋆↕4) × "1001"-\'0\'', '+´ (⌽2⋆↕4) × "1001"-\'0\'']),
    (29, ['\'0\' -˜ "01001110"‿"01100101"‿"01110010"‿"01100100"‿"00100001"']),
    (30, ['+´¨ \'0\' -˜ "01001110"‿"01100101"‿"01110010"‿"01100100"‿"00100001"']),
    (31, ['(⌽2⋆↕8) × \'0\' -˜ "01001110"‿"01100101"‿"01110010"‿"01100100"‿"00100001"']),
    (32, ['"ab" ∾¨ ⟨ "cd", "ut" ⟩', '"ab"⊸∾¨ ⟨ "cd", "ut" ⟩']),
    (33, ['+´¨ (⌽2⋆↕8)⊸×¨ \'0\' -˜ "01001110"‿"01100101"‿"01110010"‿"01100100"‿"00100001"']),
    (34, ['@ + +´¨ (⌽2⋆↕8)⊸×¨ \'0\' -˜ "01001110"‿"01100101"‿"01110010"‿"01100100"‿"00100001"']),
    (35, ['+´ (⌽2⋆↕4) × "1001"-\'0\'', '+⟜(+˜)´ ⌽ "1001"-\'0\'']),
  ],
  "03_combinators": [
    (5, ['|∘- 6']),
    (6, ['7 |∘- 9']),
    (7, ['14‿8 |∘- 19‿6', '14‿8 +´∘|∘- 19‿6']),
    (9, ['3 < 4', '4 > ∞', '∞ < @']),
    (10, ['\'e\' = "George Boole"', '+´ \'e\' = "George Boole"', '\'e\' +´∘= "George Boole"']),
    (11, ['"abcd" ×´∘= "abdd"']),
    (12, ['"abcd" ≡ "abdd"', '"abc"‿"de" ≡ "abc"‿"de"']),
    (13, ['2‿3‿4‿2 ≠ 3‿3‿2‿2', '2‿3‿4‿2 ≢ 3‿3‿2‿2']),
    (15, ['≠ "testing"', '≠ ⟨⟩', '≠ ⟨ π, ∘, "element" ⋄ ⟨\'l\',1,5,\'t\'⟩ ⟩', '≠ 4']),
    (16, ['= 0.5', '= ↕3', "= 'a'", '= "a"']),
    (17, ['≡ "dream"', '≡ "d"‿"r"‿"e"‿"a"‿"m"', '≡ ⟨ "d"‿"r"‿"e"‿"a"‿"m" ⟩']),
    (19, ['(≠"string") = ≠"sting"']),
    (20, ['=´≠¨ ⟨"string","sting"⟩']),
    (21, ['"string" =○≠ "sting"']),
    (22, ['"string" ⋈○≠ "sting"', '⋈○≠ "sting"']),
    (23, ['2 ⋆⟜- 3', '2 ⋆⊸- 3']),
    (24, ['4 -⊸⌽ " before"', '4 ⌽⁼  " before"']),
    (25, ['¬⊸× 0.5']),
    (26, ['↕⊸÷ 8', '¬⊸× ↕⊸÷ 8']),
    (27, ['1⊸+ 5', '+⟜1 5']),
    (28, ['"const"˜ 5', '@ "const"˜ 6']),
    (29, ['+⊸1 5']),
    (30, ['↕⊸÷ 8', '(↕8) ÷ 7']),
    (31, ['-⟜1 8']),
    (32, ['↕⊸÷⟜(-⟜1) 8']),
    (33, ['(↕÷-⟜1) 8']),
    (35, ['@ + +´¨ (⌽2⋆↕8)⊸×¨ \'0\' -˜ "01000010"‿"01010001"‿"01001110"']),
    (36, ['@⊸+ +´¨ (⌽2⋆↕8)⊸×¨ -⟜\'0\' "01000010"‿"01010001"‿"01001110"',
          '(@⊸+)∘(+´¨)∘((⌽2⋆↕8)⊸×¨)∘(-⟜\'0\') "01000010"‿"01010001"‿"01001110"']),
    (37, ['@⊸+∘(+´∘((⌽2⋆↕8)⊸×)¨)∘(-⟜\'0\') "01000010"‿"01010001"‿"01001110"']),
    (38, ['@⊸+∘(+´∘×⟜(⌽2⋆↕8)¨)∘(-⟜\'0\') "01000010"‿"01010001"‿"01001110"']),
    (39, ['(((((1×10)+2)×10)+3)×10)+4',
          '((1×⟜10⊸+2)×⟜10⊸+3)×⟜10⊸+4',
          '4+⟜(10⊸×)3+⟜(10⊸×)2+⟜(10⊸×)1',
          "+⟜(10⊸×)´ 4‿3‿2‿1",
          '+⟜(10⊸×)´ ⌽ 1‿2‿3‿4']),
    (40, ['+´∘×⟜(⌽2⋆↕8) "01010001"-\'0\'', '+⟜(2⊸×)´∘⌽ "01010001"-\'0\'']),
    (41, ['@⊸+∘(+⟜(2⊸×)´∘⌽¨)∘(-⟜\'0\') "01000010"‿"01010001"‿"01001110"']),
    (42, ['(@+ ·+⟜(2⊸×)´∘⌽¨ -⟜\'0\') "01000010"‿"01010001"‿"01001110"']),
  ],
  "04_variables": [
    (5, ['hey ← "Hi there"', 'hey ∾ ", World!"']),
    (7, ['pi‿e‿ten ← ⟨ π, ⋆1, 10 ⟩', 'ten × pi', 'three ⋈ ten - three ← 3']),
    (8, ['three ← 4']),  # expected error
    (9, ['three ↩ 4', 'three = 3', '3 = three ↩ 3', 'four ↩ 3']),  # last: expected error
    (11, ['BQN ← "[many pages of specification]"']),
    (12, ['three', 'thrEe', 'ThReE', 'thr_EE', '__three', '_T_H_R_E_E_']),
    (13, ['- Three', '- _three']),
    (14, ['1_000_000']),
    (16, ['Base2 ← +⟜(2⊸×)´∘⌽', 'Base2 1‿0‿1‿0', 'Base2 "01010001"-\'0\'',
          '@ + Base2¨ \'0\' -˜ "01000010"‿"01010001"‿"01001110"']),
    (17, ['Base2', 'base2 ↩ 16', 'Base2', 'Base2 6']),
    (19, ['"BQN"', '-⟜1⌾(2⊸⊑) "BQN"']),
    (20, ['(↕3) ⋈¨ "BQN"', '1 ⊑ "BQN"']),
    (21, ['8⌾⊑ "BQN"']),
    (22, ['↕7', '4 ↑ ↕7', '⌽⌾(4⊸↑) ↕7', '⌽⌾(¯4⊸↑) ↕7']),
    (23, ['2⊸⌽⌾(1⊸⊑) "xyz"‿"ABCDE"‿"wxyz"‿"yz"', '2⊸⌽⌾(2⊸↓) "XYabcde"']),
    (24, ['¯3 ↓ "abcdefgh"', '2 ↑ 4 ↓ "abcdefgh"']),
    (25, ['(\'A\'-\'a\')⊸+ ⌾ (2 ↑ 4⊸↓)  "abcdefgh"']),
    (27, ['⊢ "only"', '⊣ "only"', '"left" ⊢ "right"', '"left" ⊣ "right"']),
    (29, ['a ← 4\na', 'a ↩ 4‿5‿6\na']),
    (30, ['a ↩ a - 1\na', 'a -↩ 1']),
    (31, ['a ∾˜↩ 0‿1']),
    (32, ['"abcd" ⌽∘⊣ "wxyz"', 'a ⌽∘⊣↩ @']),
    (33, ['a ⌽↩', 'a 4⊸-↩']),
    (34, ['-⟜4⌾(¯2⊸↑) a', 'a']),
    (35, ['a -⟜4⌾(¯2⊸↑)↩']),
  ],
}

# Expected errors (notebook, cell, expr_index_in_cell)
EXPECTED_ERRORS = {
  ("04_variables", 8, 0),   # three ← 4 (already defined)
  ("04_variables", 9, 3),   # four ↩ 3 (not yet defined)
}

def main():
    total = 0
    failed = 0
    failures = []
    for nb_name, cells in NOTEBOOKS.items():
        env = EvaluationEnvironment()
        stateful = lambda src, e=env: evaluate(src, e)
        for cell_num, exprs in cells:
            for expr_idx, expr in enumerate(exprs):
                total += 1
                is_expected_error = (nb_name, cell_num, expr_idx) in EXPECTED_ERRORS
                try:
                    result, _ = stateful(expr)
                    if is_expected_error:
                        print(f"  UNEXPECTED OK: {nb_name} cell {cell_num}[{expr_idx}]: {expr!r}")
                except Exception as e:
                    if is_expected_error:
                        pass  # expected
                    else:
                        failed += 1
                        err_line = str(e).split('\n')[0][:120]
                        failures.append((nb_name, cell_num, expr_idx, expr, err_line))
                        print(f"  FAIL: {nb_name} cell {cell_num}[{expr_idx}]: {expr!r}")
                        print(f"        {err_line}")
    
    print(f"\n{'='*60}")
    print(f"Total: {total}, Failed: {failed}")
    if failures:
        print(f"\nAll failures:")
        for nb, c, i, expr, err in failures:
            print(f"  {nb} cell {c}[{i}]: {expr!r}")
            print(f"    -> {err}")

if __name__ == "__main__":
    main()
